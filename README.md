![Python 3.6](https://img.shields.io/badge/python-3.6-green.svg)
![MATLAB v7](https://img.shields.io/badge/MATLAB-v7-yelow.svg)
## Описание
C помощью алгоритмов машинного зрения cопоставляем траектории движения, полученных из сигналов по скоростям и повороту
руля, с маршрутами московских электробусов, взятых из яндекс карт.

## Проблема
Для диагностического анализа некоторых показателей электробуса надо было знать данные о погоде в момент, когда записывались логи.
В логах содержится информация о дате и времени его создания, но нет данных о номере маршрута и о том, в каком месте совершалось движение,
поэтому было принято решение находить конретный машрут, сопоставляя траекторию из логов и изображения маршрутов из сервиса яндекс транспорта.
В Москве существует около 241 различных маршрутов электробусов - вручную просматривать каждый и находить похожий было очень затратно.

## Решение
Для автоматизации поиска был создан алгоритм состоящий из методов компьютерного зрения и ML. Идея в том, что для траектории из логов мы находим наиболее похожий машрут из карт. Во время поиска наиболее точного решения
применялись разные способы создания и предобработки датасета, а так же разные модели ML.

## Решение от начала до конца

### Датасет

<p>Датасет состоит из изображений траекторий, полученных из лога электробуса и изображений машрутов, полученных из яндекс транспорта. Код для получения траектории из лога написан в matlab,
скорости были взяты с инверторов левого и правого колеса, а углы поворота из датчика поворота руля. Данные из логов могут иметь шум, и на больших дистанциях в некоторых логах
могут возникать небольшие, но заметные отклонение от реального маршрута, также лог может начинать записываться прямо из депо, поэтому к маршурту движения добавляются кривые,
которых нет в изображениях из яндекс транспорта, отличия также могут быть в ориентации в пространстве и в масштабе, все это мешает использовать четкие алгоритмы сравнения кривых.</p>
<p>Изображения маршрутов брались, как скрины из яндекс транспорта - получилось 241 изображение, так как на этом сервисе нельзя выделить только маршрут без фона, то фон убирался с помощью компьютерного зрения.
Изначально скрины брались без какой либо обработки - на траектории движения были отмечены остановки, динамические модельки электробусов, которые двигались по маршруту в момент получения скрина,
размеры получившихся изображений имели разную высоту и ширину. В дальнейшем, при тестировании, оказалось, что все эти детали оказывают существенное влиянние на точность. Самой большой проблемой были модельки 
электробусов - созданные модели нейросети слишком зацикливались на них, а не на сравнении кривизны траектории.</p>
<u>Были рассмотрены несколько вариантов решения этой проблемы </u>:
   <ol>
     <li> Парсинг траектории ввиде кординат по апи яндекс карт, а потом отрисовка. Такое решение было бы наиболее точным и удобным при дальнейшем использовании, но апи яндекс карт предоставляется на платной основе, и время потраченное на создание собственного решения было бы несопостовимо со сложностью самой задачи.
     <li> Создание скринов в ночное время, когда электробусы уже уходят с маршрутов. На некоторых маршрутах электробусы работают всю ночь, а также, при таком варианте, все равно остается прорисовка остановок, которые тоже влияли на маршрут, поэтому этот вариант оказался нерабочим.
     <li> Искусственное замедление работы сайта. Было замечено, что при переключении режимов "спутник" и "схема" в яндекс картах, первым делом отрисовывается кривая маршрута без остановок и моделей электробусов. Поэтому  с помощью настроек сайта была уменьшина скорость передачи данных и была получена возможность делать скрины только линий маршрута. Также размер скринов был квадратный, это было важно для маштабирования, которое применяется перед подачей изображения на вход в нейросеть.
     </ol>
Третий вариант оказался самым рабочим, при помощи него был создан датасет кривых линий маршрутов.

### Обработка

Изначально для изображений применялась самая простая обработка. Определялся rgb с погрешностью для кривой линии маршрута, для него выделялась маска, а весь остальной фон делался белым, такие изображения далее использовались в алгоритмах для сравнения. Но оказалось, что положение кривой в пространстве так же играет существенную роль даже при использовании моделей глубокого обучения. Поэтому для всех изображений была применена обработка с помощью минимально оборачивающего прямоугольника - находилсь контуры прямой и вокруг этих контуров оборачивался прямоугольник, который потом доворачивался в горизонтальное положение без потери "квадратности" изображения. Этот вариант давал хорошие результаты, но для некоторых случаев был неточен, из-за погрешностях в некоторых логах, прямогольник мог создаться по другим контурам. Поэтому был использован другой вариант, который будет описан дальше, он занимает больше памяти, но зато дает большую точность.

### Сравнение

Сравнение происходило в несколько этапов:
<ol>
  <li> Получения признаков изображений с помощью  моделей глубокого обучения. Были протестированы 3 модели: EfficientNet, ResNet, Dino и сиамские сети. От каждой модели брались нейросети с разным размером, а так же тестировались разные размеры входного изображения. Самой точной моделью оказалась EfficientNetB7 со всходом 480 на 480. Так как нам была важна ориентация кривой, было принято решение прокрутить кривую на 360 градусов с шагом 1 градус и получать признаки на каждом шаге, это было сделано только для скринов с яндекс карт, признаки были сохранены в формате .pkl.
  <li> Признаки сравниваются с помощью библиотеки fiass. Был создан код, который сравнивал полученные расстояния между признаками траекторий из логов и всех признаков скринов яндекс карт, и выводил топ 5 уникальных и наиболее близких.
  </ol>
  
### Тестирование

До появления этой задачи не существовало никакой базы логов, которые были бы уже сопоставленны с номерами маршрутов, поэтом результаты работы алгоритма проверялись вручную.

### Варианты дальнейших улучшений

Для создания более уневерсального алгоритма планируется найти логи для всех номеров маршрутов, далее добавить дополнительный слой к модели нейросети и обучить ее на этих изображениях до обработки, таким спсобом можно улучшить вес признаков, которые относятся именно к траектории движения и к той ее части, которая наиболее значима для сопоставления.


  


